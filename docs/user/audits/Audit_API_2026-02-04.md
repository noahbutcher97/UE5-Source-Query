# Audit: API Architecture & Service Layer (v2.1)

## ## Metadata
- **Author**: Gemini-CLI Intelligence Layer
- **Date Created**: 2026-02-04
- **Project**: UE5 Source Query System
- **Status**: Final Audit Report
- **Version**: 1.0.0 (SemVer)
- **License**: MIT
- **Contact**: posner.noah@gmail.com

---

## ## Overview
The current API implementation in `ue5_query/server/retrieval_server.py` relies on the synchronous `http.server.BaseHTTPRequestHandler`. This architecture is unsuitable for production as it blocks the main thread during heavy ML computations, leading to service degradation under concurrent load. This audit outlines 20 mandatory refactors to transition to an asynchronous, robust REST API using FastAPI.

---

## ## Refactoring Recommendations (Top 20)

### 1. Asynchronous Request Handling (FastAPI)
- **Description**: Migrate the server from `BaseHTTPRequestHandler` to `FastAPI` with `uvicorn`.
- **Purpose**: Enable non-blocking I/O to handle concurrent queries and health checks.
- **Example**: `app = FastAPI(); @app.get("/search") async def search(q: str): ...`
- **Dependencies**: `fastapi==0.109.2`, `uvicorn==0.27.1`
- **Success Metric**: 100% availability during 10+ concurrent semantic searches.

### 2. Pydantic Schema Validation
- **Description**: Replace manual JSON parsing with Pydantic models.
- **Purpose**: Ensure data integrity and provide automatic error documentation.
- **Example**: `class QueryRequest(BaseModel): q: str; top_k: int = 5`
- **Errors**: `422 Unprocessable Entity` for invalid types.

### 3. API Versioning Strategy
- **Description**: Implement path-based versioning (e.g., `/api/v1/search`).
- **Purpose**: Prevent breaking changes for downstream AI agents and legacy CLI clients.
- **Success Metric**: Ability to deploy v2 endpoints without impacting v1 users.

### 4. Semantic Result Caching
- **Description**: Integrate a Redis-backed caching layer for high-frequency queries.
- **Purpose**: Reduce GPU/CPU utilization by 70% for common "What is X" queries.
- **Dependencies**: `redis==5.0.1`

### 5. API Key Middleware
- **Description**: Implement an authentication middleware layer.
- **Purpose**: Secure the API for team deployments and prevent unauthorized index access.
- **Errors**: `401 Unauthorized` for missing/invalid keys.

### 6. Relationship Intelligence Endpoint
- **Description**: Expose Phase 5 relationship extraction logic via `GET /v1/entities/{name}/graph`.
- **Purpose**: Allow external tools to visualize class hierarchies and dependencies.

### 7. Optimized Batch Search
- **Description**: Implement a dedicated `POST /v1/batch` endpoint.
- **Purpose**: Enable efficient bulk processing of multiple queries in a single embedding pass.
- **Success Metric**: 30% reduction in latency for batch sizes > 10.

### 8. Dynamic Source Management
- **Description**: API endpoints to add/remove indexed directories at runtime.
- **Purpose**: Eliminate server restarts when updating project source paths.

### 9. Liveness & Readiness Probes
- **Description**: Differentiate between `/health/live` and `/health/ready`.
- **Purpose**: Ensure the server only accepts traffic after the 1.5GB ML model is fully loaded in VRAM.

### 10. CORS Security Policy
- **Description**: Configure `CORSMiddleware` with strict origin allow-lists.
- **Purpose**: Enable the Unified Dashboard GUI to communicate with remote server instances securely.

### 11. Request Rate Limiting
- **Description**: Implement IP-based rate limiting via `slowapi` or similar.
- **Purpose**: Protect the server from accidental or malicious denial-of-service spikes.

### 12. Gzip Payload Compression
- **Description**: Enable Gzip compression for JSON responses.
- **Purpose**: Reduce bandwidth usage by 60% for large result sets containing full code blocks.

### 13. Correlation IDs (Tracing)
- **Description**: Inject `X-Request-ID` into all response headers.
- **Purpose**: Facilitate end-to-end tracing of queries across logs and client reports.

### 14. Runtime Configuration Updates
- **Description**: `PATCH /v1/config` endpoint for updating `top_k` or `confidence_threshold`.
- **Purpose**: Fine-tune search behavior without downtime or manual config file edits.

### 15. OpenAPI / Swagger Integration
- **Description**: Enable automatic Swagger UI at `/docs`.
- **Purpose**: Provide self-documenting interactive playground for team members.

### 16. Streaming Batch Results
- **Description**: Use `StreamingResponse` for long-running batch query exports.
- **Purpose**: Prevent memory exhaustion when exporting thousands of search matches to JSONL.

### 17. Standardized Error Envelope
- **Description**: Implement global exception handlers returning a consistent JSON format.
- **Example**: `{"error": {"code": "ERR_ENTITY_NOT_FOUND", "message": "..."}}`

### 18. Structured Telemetry Logging
- **Description**: Log status codes, latencies, and query intent to JSON files.
- **Purpose**: Enable data-driven insights using ELK/Grafana stacks.

### 19. Dependency Injection (DI)
- **Description**: Use FastAPI's `Depends` system for injecting the `HybridQueryEngine`.
- **Purpose**: Simplify unit testing by allowing easy swapping of "Real" vs "Mock" engines.

### 20. Static Documentation Server
- **Description**: Serve `docs/` as a static site via the API.
- **Purpose**: Ensure documentation and the API version are always perfectly in sync.

---

## ## Prioritized Task Registry

| Task ID | Description | Effort | Impact (1-5) | Success Metric |
| :--- | :--- | :--- | :--- | :--- |
| **API-01** | **FastAPI Migration** | High | 5 | Concurrent I/O stability |
| **API-02** | **Redis Caching** | Medium | 5 | <100ms avg response |
| **API-03** | **Pydantic Validation** | Low | 4 | 0% type-based crashes |
| **API-04** | **API Key Auth** | Low | 4 | Secure team access |
| **API-05** | **Auto-Swagger** | Low | 3 | Interactive documentation |
| **API-06** | **Batch Search** | Medium | 4 | 30% GPU time savings |
| **API-07** | **Relationship API** | Medium | 3 | Full hierarchy access |
| **API-08** | **CORS Middleware** | Low | 3 | Web Dashboard support |
| **API-09** | **Deep Health Probes** | Low | 2 | Accurate load balancing |
| **API-10** | **Rate Limiting** | Medium | 4 | System stability |
| **API-11** | **Gzip Encoding** | Low | 2 | 60% bandwidth reduction |
| **API-12** | **Request Tracing** | Low | 2 | 100% log traceability |
| **API-13** | **Config API** | Low | 3 | 0-restart tuning |
| **API-14** | **JSON Logging** | Low | 3 | ELK/Splunk ready |
| **API-15** | **Streaming API** | Medium | 4 | No-timeout batching |
| **API-16** | **Error Wrappers** | Low | 3 | 0 internal leak risk |
| **API-17** | **Source API** | Medium | 4 | Dynamic re-indexing |
| **API-18** | **DI Container** | Medium | 3 | Test coverage > 85% |
| **API-19** | **Static Docs** | Low | 2 | Unified developer portal |
| **API-20** | **Telemetry** | Medium | 4 | Query behavior insights |

---
*End of Report*
